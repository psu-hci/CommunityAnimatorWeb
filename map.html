<!DOCTYPE html>
<html>
  <head>
	<title>Update Location</title>
    <style type="text/css">
      html, body { height: 100%; margin: 0; padding: 0; }
      #map { height: 80%; width: 100%}
    </style>
	<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
<link rel="icon" href="favicon.ico" type="image/x-icon">
	   <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!--Import materialize.css-->
  <link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/> 
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-70177830-1', 'auto');
  ga('send', 'pageview');

</script>
  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script type="text/javascript" src="js/materialize.min.js"></script>
  <script type="text/javascript" src="http://www.parsecdn.com/js/parse-latest.js"></script>
  </head>
  <body>
  <nav>
    <div class="nav-wrapper white">
      <a href="main.html" class="brand-logo">&nbsp<img src = "images/logo.jpg"></img></a>
	        <ul id="nav-mobile" class="right hide-on-med-and-down">
		<li><a href="main.html"><font color="orange">Home</font></a></li>
		<li><a href="usermap.html"><font color="orange">User Map</font></a></li>
		<li><a href="userlist.html"><font color="orange">User List</font></a></li>
		<li class = "active"><a href="map.html"><font color="orange"><b>Update Location</b></font></a></li>
		<li><a href="logout.html"><font color="orange">Log Out</font></a></li>
      </ul>
    </div>
  </nav>
	<center><h2>Update Location</h2></center>
	<center><h6><i>Click to drop new pin</i></h6>	
	<br/>
    <center><div id="map"></div></center>
	<br/><br/>
	 <center><button class="btn waves-effect waves-light orange" type="submit" name="action" onclick="updateLocation()">Update
    
  </button></center>
	
    <script type="text/javascript">

	Parse.initialize("T4lD84ZeLY7615h43jpGlVTG5cXZyXd8ceSGX29e", "KPVDbWy1zWbJD1WPG4HReba5urgHsPVJgh9wX5D1");
	
	var map;
	var markers = [];
	var latitude;
	var longitude;
	
	
	function initMap() {
		map = new google.maps.Map(document.getElementById('map'), {
		center: {lat: 40.799361, lng: -77.862548},
		zoom: 16,
		//mapTypeId: google.maps.MapTypeId.HYBRID
	});
  
		Parse.User.current().fetch().then(function (user) {
		latitude = user.get('location').latitude;
		longitude= user.get('location').longitude;
		addOldMarker({lat: latitude, lng: longitude});
		map.panTo({lat: latitude, lng: longitude});
		});
		
		map.addListener('click', function(e) {
		placeMarkerAndPanTo(e.latLng, map);
	});
  
   // This event listener will call addMarker() when the map is clicked.
	map.addListener('click', function(event) {
    addMarker(event.latLng);
  });
  
  // Adds a marker to the map and push to the array.
	function addMarker(location) {
	  var marker = new google.maps.Marker({
		position: location,
		map: map,
		icon: 'http://maps.google.com/mapfiles/ms/micons/orange-dot.png',
	  });
	  markers.push(marker);
	}
	
	  // Adds a marker to the map and push to the array.
	function addOldMarker(location) {
	  var marker = new google.maps.Marker({
		position: location,
		map: map,
		animation: google.maps.Animation.DROP,
		icon: 'http://maps.google.com/mapfiles/ms/micons/orange-dot.png',
		title:"Previous Location"
	  });
	  markers.push(marker);
	}

	// Sets the map on all markers in the array.
	function setMapOnAll(map) {
	  for (var i = 0; i < markers.length; i++) {
		markers[i].setMap(map);
	  }
	}

	// Removes the markers from the map, but keeps them in the array.
	function clearMarkers() {
	  setMapOnAll(null);
	}

	// Shows any markers currently in the array.
	function showMarkers() {
	  setMapOnAll(map);
	}

	// Deletes all markers in the array by removing references to them.
	function deleteMarkers() {
	  clearMarkers();
	  markers = [];
	}
  
  function placeMarkerAndPanTo(latLng, map) {
  deleteMarkers();
  addMarker(latLng);
  latitude = latLng.lat();	
  longitude = latLng.lng();
  map.panTo(latLng);
}
}
	function updateLocation(){
		
		var user = Parse.User.current();
		Materialize.toast("Location Updated!", 4000) // 4000 is the duration of the toast
		user.set("location", new Parse.GeoPoint({latitude: latitude, longitude: longitude}));
		return user.save();
		
	}
    </script>
	
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyABEC6CnoN-OnqTOp_3U88bowd_cCiXJZw&callback=initMap">
    </script>
  </body>
</html>